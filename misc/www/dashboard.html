<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">

    <title>putget demo dashboard</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            outline: none;
            box-sizing: border-box;
        }

        #container {
            background-color: #585858;
            box-shadow: inset 0 0 1em black;
            min-height: 100vh;
            text-align: center;
            justify-items: center;
            align-items: center;
            display: grid;
            grid-template-columns: 1fr 1fr;
            padding-bottom: 2em;
        }

        #container img {
            display: inline-block;
            max-width: 47vw;
            max-height: 47vh;
            margin: 0.5vh auto;
            padding: 0;
            border: 1px solid #808080;
            box-shadow: 0 0 0.25em darkgray;
        }

        #container img.loading {
            filter: grayscale(50%);
            border-color: darkorange;
        }

        @media (orientation: portrait) {
            #container {
                grid-template-columns: 1fr;
            }

            #container img {
                max-width: 90vw;
            }
        }
    </style>

    <script>
        const dummy_img = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="navy"/></svg>';

        const dashboard = {

            URL: "/",
            UPDATE_INTERVAL: 15 * 1000,
            ZOOM_SCALE: 60,
            ZOOM_SCALE_TURBO: 900,
            listing: [],
            container: null,
            images: [],
            xssec: null,

            init: function () {
                let params = new URLSearchParams("");
                if (window.location.search) {
                    params = new URLSearchParams(window.location.search);
                } else if (window.location.hash) {
                    params = new URLSearchParams(String(window.location.hash).substring(1));
                }
                let ssek = params.get("ssek");
                if (ssek == "-") {
                    this.ssek = prompt("sse key");
                } else {
                    this.ssek = ssek;
                }
                let csek = params.get("csek");
                if (csek == "-") {
                    this.csek = prompt("cse key");
                } else {
                    this.csek = csek;
                }
                this.fetch_listing();
            },

            fetch_listing: function () {
                this.listing = [];
                fetch(this.URL)
                    .then(rsp => rsp.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            for (let i = 0; i < data.length; i++) {
                                let name = data[i].name || "";
                                let ct = String(data[i].last && data[i].last.content_type) || "";
                                if (ct.toLowerCase().includes("image")) {
                                    this.listing.push([name, ct]);
                                }
                            }
                            this.listing.sort((a, b) => { return a[0].localeCompare(b[0]); });
                            if (this.listing && this.listing.length > 0) {
                                this.create_images();
                            }
                        }
                    });
            },

            create_images: function () {

                this.container = document.getElementById("container");
                this.images = [];

                for (let i = 0; i < this.listing.length; i++) {

                    let el = document.createElement("img");
                    el.setAttribute("data-id", this.images.length);
                    el.addEventListener("click", ev => { this.image_click(ev); });
                    el.addEventListener("wheel", ev => { this.image_wheel(ev); });
                    this.container.appendChild(el);

                    let url = String(this.URL + this.listing[i][0]);

                    let img = { el: el, src: url, title: this.listing[i][0], ts: 0, before: 0, loading: false };
                    this.images.push(img);
                }

                this.update_images();
                this.tm = setInterval((ev) => { this.update_images(); }, this.UPDATE_INTERVAL);

            },

            update_images: function () {
                for (let i = 0; i < this.images.length; i++) {
                    if (this.images[i].before > 0 || this.images[i].loading) {
                        continue;
                    }
                    this.update_image(i);
                }
            },

            update_image: function (idx) {

                let img = this.images[idx];

                if (img.loading) { return; }
                img.loading = true;
                img.el.classList.add("loading");

                var qs = new URLSearchParams();
                qs.append("ts", (+new Date()));
                if (img.before > 0) { qs.append("before", img.before); }
                let url = img.src + "?" + qs.toString();
                let headers = {
                    "Cache-Control": "no-cache",
                    "Pragma": "no-cache",
                    "Expires": "0"
                };
                if (this.ssek) { headers["X-SSE-C"] = this.ssek; }

                fetch(url, { headers: headers })
                    .then(rsp => {
                        if (rsp.ok) {
                            return Promise.all([rsp, rsp.arrayBuffer()]);
                        }
                        console.error("failed to fetch image:", rsp.status, rsp.statusText);
                    })
                    .then(([rsp, buffer]) => {
                        let image_data;
                        if (this.csek) {
                            image_data = this.decrypt(buffer, this.csek)
                                .then(decrypted => {
                                    const blob = new Blob([decrypted], { type: rsp.headers.get('Content-Type') });
                                    return URL.createObjectURL(blob);
                                });
                        } else {
                            const blob = new Blob([buffer], { type: rsp.headers.get('Content-Type') });
                            image_data = Promise.resolve(URL.createObjectURL(blob));
                        }
                        return Promise.all([rsp, buffer, image_data]);
                    })
                    .then(([rsp, buffer, data]) => {
                        let last_modified = rsp.headers.get('Last-Modified');
                        let last_modified_ts = (new Date(last_modified)).getTime() / 1000;
                        if (last_modified_ts) { img.ts = last_modified_ts; }
                        img.el.setAttribute("src", data);
                        img.el.setAttribute("title", img.title + "\n"
                            + last_modified + "\n"
                            + (buffer.byteLength / (1024) | 0) + "kB");
                    })
                    .catch(error => {
                        console.error("failed to update image:", error);
                        img.el.setAttribute("src", dummy_img);
                        img.el.setAttribute("title", "error:\n" + String(error));
                    })
                    .finally(() => {
                        img.el.classList.remove("loading");
                        img.loading = false;
                    });
            },

            decrypt: function (buffer, key) {
                const iv_size = 16;
                if (buffer.byteLength < iv_size) {
                    return Promise.reject(new Error("ciphertext too short"));
                }
                const iv = buffer.slice(0, iv_size);
                const data = buffer.slice(iv_size);
                return window.crypto.subtle.digest('SHA-256', new TextEncoder().encode(key))
                    .then(hashed_key =>
                        window.crypto.subtle.importKey(
                            "raw", hashed_key, { name: "AES-CTR" }, false, ["decrypt"]
                        )
                    ).then(crypto_key =>
                        window.crypto.subtle.decrypt(
                            { name: "AES-CTR", counter: iv, length: 128 }, crypto_key, data
                        )
                    );
            },

            image_wheel: function (ev) {
                ev.preventDefault();
                let idx = ev.target.getAttribute("data-id");
                let img = this.images[idx];
                let zoom = ((ev.deltaY > 0) ? -1 : 1) * ((ev.shiftKey) ? this.ZOOM_SCALE_TURBO : this.ZOOM_SCALE);
                if (!img.before) { img.before = img.ts; }
                img.before += zoom;
                setTimeout((ev) => { this.update_image(idx); }, 250);
            },

            image_click: function (ev) {
                ev.preventDefault();
                let idx = ev.target.getAttribute("data-id");
                this.images[idx].before = 0;
                this.update_image(idx);
            }

        };

        document.addEventListener("DOMContentLoaded", ev => dashboard.init());
    </script>

</head>

<body>
    <div id="container">
    </div>
</body>

</html>